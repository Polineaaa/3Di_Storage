{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>3D Storage</title>
<!-- ... –≤–∞—à–∏ —Å—Ç–∞—Ä—ã–µ —Ç–µ–≥–∏ ... -->
<!-- –í–ê–ñ–ù–û: –≠—Ç–æ –∫–∞—Ä—Ç–∞, —É–∫–∞–∑—ã–≤–∞—é—â–∞—è –±—Ä–∞—É–∑–µ—Ä—É, –≥–¥–µ –±—Ä–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<script type="importmap">
{
"imports": {
"three": "https://unpkg.com/three@0.160.0/build/three.module.js",
"three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
}
}
</script>
<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ CSS (–æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –±—ã–ª–æ) -->
<link rel="stylesheet" href="{% static 'gallery/style.css' %}">

</head>
<body>

<header>
    <h1>{{ page_title }}</h1>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É -->
    <a href="{% url 'upload' %}" class="btn" style="background-color: #28a745;">
        + –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å
    </a>
</header>

<main>
    <!-- –°–µ—Ç–∫–∞ –≥–∞–ª–µ—Ä–µ–∏ -->
    <div class="gallery-grid">

        {% for asset in assets %}
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="asset-card">

            <!-- –ü—Ä–µ–≤—å—é (–∑–∞–≥–ª—É—à–∫–∞ –ø–æ–¥ 3D) -->
            <div class="card-preview js-load-3d"
                 id="model-container-{{ asset.id }}"
                 {% if asset.file %}
                 data-url="{{ asset.file.url }}"
                 {% endif %}

                 {% if asset.image %}
                    style="background-image: url('{{ asset.image.url}}');"
                 {% endif %}
            >
            {% if asset.image %}
                <div class ="play-btn">‚ñ∂Ô∏è</div>
            {% else %}
                <span style="font-size: 2rem;">üé≤</span>
            {% endif %}
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="card-info">
                <h3 class="card-title">{{ asset.title }}</h3>

                <div class="card-meta">
                    <span>üìÖ {{ asset.created_at|date:"d M Y" }}</span>

                    {% if asset.file %}
                    <span style="float: right;">
                        üíæ {{ asset.file.size|filesizeformat }}
                    </span>
                    {% endif %}
                </div>

                {% if asset.file %}
                    <a href="{{ asset.file.url }}" class="btn" download>
                        –°–∫–∞—á–∞—Ç—å .glb
                    </a>
                {% else %}
                    <span style="color: red;">–§–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</span>
                {% endif %}
            </div>
        </div>
        {% empty %}
            <p>–ë–∞–∑–∞ –ø—É—Å—Ç–∞.</p>
        {% endfor %}

    </div>
</main>
<!-- type="module" –≤–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ -->
<script type="module">
    import { loadModel } from "{% static 'gallery/js/viewer.js' %}";
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –±–ª–æ–∫–∏, –≥–æ—Ç–æ–≤—ã–µ –∫ 3D
    const containers = document.querySelectorAll('.js-load-3d');
    containers.forEach(container => {
        // –í–µ—à–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç–æ—á–∫—É
        container.addEventListener('click', function() {
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞: –ï—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ —É–∂–µ –µ—Å—Ç—å canvas, –∑–Ω–∞—á–∏—Ç –º–æ–¥–µ–ª—å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
            if (this.querySelector('canvas')) return;
            // 1. –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É Play (–æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç)
            // –ù–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ–Ω, –ø–æ–∫–∞ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è Canvas, —á—Ç–æ–±—ã –Ω–µ –º–∏–≥–∞–ª–æ –±–µ–ª—ã–º
            this.innerHTML = ''; 
            this.style.backgroundImage = 'none';
            // 2. –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–∏–Ω–Ω–µ—Ä (–≤–∏–∑—É–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
         
            // 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É 3D
            const id = this.id;
            const url = this.dataset.url;
            
            if (url) {
                console.log("–ó–∞–≥—Ä—É–∂–∞—é 3D –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é:", url);
                loadModel(id, url);
                
                // –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É, –∫–æ–≥–¥–∞ 3D –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è? 
                // loadModel —Å–∞–º –æ—á–∏—Å—Ç–∏—Ç innerHTML –∏ –ø–µ—Ä–µ–∫—Ä–æ–µ—Ç —Ñ–æ–Ω –∫–∞–Ω–≤–∞—Å–æ–º.
            }
        });
    });
</script>

</body>
</html>
