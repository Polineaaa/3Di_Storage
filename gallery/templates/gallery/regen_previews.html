{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é</title>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: 20px auto; padding: 0 16px; }
    .row { display: grid; grid-template-columns: 1fr 320px; gap: 16px; padding: 16px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 12px; }
    .preview { width: 300px; height: 200px; background: #eee; border: 1px solid #ccc; display:flex; align-items:center; justify-content:center; }
    button { padding: 8px 12px; cursor: pointer; }
    .status { color: #555; font-size: 0.9rem; margin-top: 6px; }
    .ok { color: #1a7f37; }
    .bad { color: #b42318; }
  </style>
</head>
<body>

  <h1>–î–æ—Å–æ–∑–¥–∞—Ç—å –ø—Ä–µ–≤—å—é –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –º–æ–¥–µ–ª–µ–π</h1>

  <p>
    –¢—É—Ç —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ –±–µ–∑ –ø—Ä–µ–≤—å—é. –ù–∞–∂–º–∏ ‚Äú–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å‚Äù - –±—Ä–∞—É–∑–µ—Ä –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç GLB –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
  </p>

  <p><a href="{% url 'home' %}">‚Üê –í –≥–∞–ª–µ—Ä–µ—é</a></p>

  {% if assets %}
    {% for asset in assets %}
      <div class="row"
           data-asset-id="{{ asset.id }}"
           data-model-url="{{ asset.file.url }}">
        <div>
          <div><b>{{ asset.title }}</b></div>
          <div class="status" id="status-{{ asset.id }}">–û–∂–∏–¥–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
          <div style="margin-top: 10px;">
            <button class="btn-generate" data-id="{{ asset.id }}">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div class="preview" id="preview-{{ asset.id }}">
          –í—ã–±–µ—Ä–∏ ‚Äú–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å‚Äù
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>–í—Å–µ –ø—Ä–µ–≤—å—é —É–∂–µ –µ—Å—Ç—å üéâ</p>
  {% endif %}

  <script>
    // CSRF –¥–ª—è fetch POST
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');
  </script>

 <script type="module">
  import * as THREE from 'three';
  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

  async function postPreview(assetId, dataURL) {
    const formData = new FormData();
    formData.append('image_data', dataURL);

    const resp = await fetch(`/save-preview/${assetId}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: formData
    });

    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error(txt || 'Server error');
    }
    return resp.json();
  }

  function setStatus(id, text, cls) {
    const el = document.getElementById(`status-${id}`);
    if (!el) return;
    el.textContent = text;
    el.classList.remove('ok', 'bad');
    if (cls) el.classList.add(cls);
  }

  function generateThumbToDataURL(previewContainer, modelUrl) {
    return new Promise((resolve, reject) => {
      const width = 300;
      const height = 220;

      const scene = new THREE.Scene();
      scene.background = null;

      const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100);

      const renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
        preserveDrawingBuffer: true
      });

      renderer.setSize(width, height);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.setClearColor(0x000000, 0); // –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω

      previewContainer.innerHTML = '';
      previewContainer.appendChild(renderer.domElement);

      scene.add(new THREE.AmbientLight(0xffffff, 1.4));
      const dir = new THREE.DirectionalLight(0xffffff, 1.2);
      dir.position.set(5, 10, 7);
      scene.add(dir);

      const loader = new GLTFLoader();
      loader.load(
        modelUrl,
        (gltf) => {
          const model = gltf.scene;

          // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
          const box = new THREE.Box3().setFromObject(model);
          const center = box.getCenter(new THREE.Vector3());
          const size = box.getSize(new THREE.Vector3());
          const maxDim = Math.max(size.x, size.y, size.z);

          model.position.sub(center);
          scene.add(model);

          // –ö–∞–º–µ—Ä–∞
          const fov = (camera.fov * Math.PI) / 180;
          const cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2)) * 1.6;

          camera.position.set(cameraZ * 0.55, cameraZ * 0.45, cameraZ);
          camera.lookAt(0, 0, 0);

          renderer.render(scene, camera);

          // –í–ê–ñ–ù–û: PNG (—Å –∞–ª—å—Ñ–æ–π)
          const dataURL = renderer.domElement.toDataURL('image/png');

          // –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
          renderer.dispose();
          resolve(dataURL);
        },
        undefined,
        (err) => {
          renderer.dispose();
          reject(err);
        }
      );
    });
  }

  document.querySelectorAll('.btn-generate').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const row = btn.closest('.row');
      const modelUrl = row.dataset.modelUrl;
      const preview = document.getElementById(`preview-${id}`);

      try {
        btn.disabled = true;
        setStatus(id, '–ì–µ–Ω–µ—Ä–∏—Ä—É—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ...', null);

        const dataURL = await generateThumbToDataURL(preview, modelUrl);

        setStatus(id, '–û—Ç–ø—Ä–∞–≤–ª—è—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä...', null);
        await postPreview(id, dataURL);

        setStatus(id, '–ì–æ—Ç–æ–≤–æ ‚úÖ –û–±–Ω–æ–≤–∏ –≥–∞–ª–µ—Ä–µ—é', 'ok');
      } catch (e) {
        console.error(e);
        setStatus(id, '–û—à–∏–±–∫–∞ ‚ùå (—Å–º. Console)', 'bad');
        btn.disabled = false;
      }
    });
  });
</script>


</body>
</html>
